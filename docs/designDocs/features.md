# 機能仕様書

## 概要
アイドルマスター vα-liv (ヴイアラ) のメンバー（灯里愛夏、上水流宇宙、レトラ）の活動をチェックするための CLI ツール `valiv` の機能と振る舞いを定義します。

## グローバルオプション
- `--version`, `-v`: バージョン情報を表示します。
- `--help`, `-h`: ヘルプを表示します。

## コマンド一覧

### 1. `init`
初期設定を行います。
- **機能**: 
    - ユーザーにアスキーアートによるウェルカムメッセージを表示します。
    - YouTube Data API Token の入力を求めます。（スキップ可能）
        - Tokenが入力された場合、登録者数などの詳細情報が取得可能になります。
    - vα-liv公式メンバー（灯里愛夏、上水流宇宙、レトラ、公式）のデータを自動的に初期設定します。
- **使用法**: `valiv init`

### 2. `add`
追跡対象のクリエイター（推し）を新規登録します。
- **機能**: 対話形式で以下の情報を入力させ、設定ファイルに保存します。
    - 名前 (必須)
    - YouTube Channel ID (任意)
    - Twitch Channel ID (任意)
    - X Username (任意)
    - Google Calendar iCal URL (任意)
- **使用法**: `valiv add`

### 3. `remove`
登録済みのクリエイターを削除します。
- **機能**: 登録されているクリエイターの一覧を表示し、選択したクリエイターを削除します。
- **使用法**: `valiv remove`

### 4. `list`
登録済みのクリエイター一覧を表示します。
- **機能**: 
    - 登録されているクリエイターの名前と各サービスのID設定状況を表形式で表示します。
    - **YouTube API Tokenが設定されている場合**: 登録者数（Subscribers）も表示します。
- **引数**:
    - `--detail` (`-d`): 詳細情報を表示します。登録者数は省略せず（例: `100,000`）表示されます。
    - `--interactive` (`-i`): インタラクティブモードを有効にします。
- **使用法**:
    - `valiv list --detail`
    - `valiv list --interactive`
        - インタラクティブモードでは `↑` `↓` キーで選択し、`Enter` で詳細アクションを表示します。
        - `q` キーで終了します。

### 5. `check`
クリエイターの最新の活動状況を確認します。
- **機能**:
    - 登録された全クリエイター（または指定されたクリエイター）のYouTube更新情報を取得します。
    - 結果を時系列順（新しい順）にソートして表示します。
    - **ページネーション**:
        - 1ページあたり10件を表示します。
        - リストの末尾にある「Next Page」「Previous Page」を選択してページ切り替えが可能です。
    - **インタラクティブモード**:
        - `↑` `↓` キーでリスト内をナビゲートできます。
        - `Enter` キーで選択したアクティビティを再生します。
        - `q` キーで終了します。
    - **動画再生**:
        - `mpv` がシステムにインストールされている場合、`node-mpv` を使用して直接再生します。
        - `mpv` が利用できない場合、デフォルトブラウザでURLを開きます。
        - `--audio-only` (`-a`) オプション:
            - 映像ウィンドウを表示せず、音声のみを再生します。
            - 再生中はCLIに再生中のタイトル、進捗バー、操作ガイドが表示され、`q` キーで停止・終了できます。
        - `--debug` (`-d`) オプション:
            - `valiv_debug.log` ファイルに詳細なログを出力します。
            - `yt-dlp` の verbose ログも含まれます。
    - **キャッシュ機能**:
        - 取得したデータは1日間キャッシュされます。
        - 2回目以降の実行時はキャッシュを利用するため高速に表示されます。
        - `--refresh` (`-r`) オプションを指定すると、キャッシュを無視して最新データを再取得します。
    - **フィルタリング**:
        - 視聴回数（views）が `0` のコンテンツ（配信予定枠や待機所など）は一覧に表示されません。
    - 現状はYouTubeのRSSフィードを利用して直近の動画/配信を取得します。
- **引数**:
    - `id` (任意): 特定のクリエイターのみチェックする場合に指定。
        - **マッチング仕様**:
            - 部分一致 (Substring match)
            - 大文字・小文字を区別しない (Case-insensitive)
            - スペース区切りで複数キーワード指定可能 (AND検索)
            - 検索対象: 名前 (Name), ID, X Username
- **オプション**:
    - `--refresh` (`-r`): キャッシュを無視してデータを再取得します。
    - `--audio-only` (`-a`): 音声のみ再生します。
    - `--debug` (`-d`): デバッグログを出力します。
- **使用法**:
    - `valiv check`
    - `valiv check "Creator Name"`
    - `valiv check "tomori manaka"` (キーワード検索)

### 6. `schedule`
クリエイターの今後のスケジュールを確認します。
- **機能**:
    - Google Calendar (iCal) が登録されているクリエイターの予定を取得します。
    - 現在時刻以降のイベントを抽出し、開始日時順に表示します。
    - **表示内容**:
        - イベントのタイトルと開始・終了時刻（利用可能な場合）をリスト形式で表示します。
        - URLや詳細な説明文は表示されません。
    - **ページネーション**:
        - 1ページあたり10件を表示します。
        - `←` `→` キーでページ切り替えが可能です。
        - `q` キーで終了します。
    - **週間カレンダーモード**:
        - `--week` (`-w`) オプションを指定すると、直近1週間の予定をグラフィカルな列形式で表示します。
        - このモードでは、レイアウト崩れを防ぐためクリエイターのシンボル（絵文字）は非表示になります。
    - **データソース**:
        - デフォルトでは Google Calendar (iCal) から情報を取得します。
        - **YouTube API Tokenが設定されている場合**:
            - **統合ロジック**:
                - YouTube Data API から直近1ヶ月の配信予定を取得します。
                - iCal からも全ての予定を取得します。
                - **重複排除**: 「同一クリエイター」かつ「iCalで取得した予定の[開始時刻, 終了時刻]の期間内に、YouTube APIで取得した配信の開始時刻が含まれる」場合、それを「同一の配信」とみなします。この場合、情報の正確性が高い YouTube API 側のデータを優先して表示し、iCal側の予定は非表示とします。**ただし、終了時刻についてはiCal側の情報がある場合、それを優先して採用します。**
                - マッチしないiCalの予定（Twitch配信や、API未反映の予定など）はそのまま表示されます。
    - **キャッシュ機能**:
        - `check` コマンドと同様に1日間キャッシュされます。
        - `--refresh` (`-r`) オプションで強制更新が可能です。
- **引数**:
    - `id` (任意): 特定のクリエイターのみチェックする場合に指定。
        - **マッチング仕様**: `check` コマンドと同様。
- **オプション**:
    - `--week` (`-w`): 1週間のグラフィカルなスケジュールを表示します。
    - `--refresh` (`-r`): キャッシュを無視してデータを再取得します。
- **使用法**:
    - `valiv schedule`
    - `valiv schedule -w`


### 7. `open`
クリエイターの各サービスページをブラウザで開きます。
- **機能**: 指定されたプラットフォームのURLを生成し、デフォルトブラウザで開きます。
- **引数**:
    - `name` (必須): クリエイター名
    - `platform` (必須): `youtube`, `twitch`, `x` のいずれか
- **使用法**:
    - `valiv open "Creator Name" youtube`

## 外部サービス連携仕様

### YouTube
- **取得方法**: チャンネルRSSフィード (`https://www.youtube.com/feeds/videos.xml?channel_id=...`)
- **認証**: 不要
- **制限**: RSSには直近の15件程度の動画/配信アーカイブのみが含まれます。予定されている配信は含まれない場合があります。
- **API連携**: YouTube Data API Tokenが設定されている場合、`schedule` コマンドにて配信予定をAPI経由で取得します (`search` endpointを使用)。

### Google Calendar
- **取得方法**: 公開カレンダーのiCal形式 (.ics) URL
- **認証**: 不要（公開設定であること）
- **処理**: iCal形式のデータをパースし、直近の予定を抽出します。説明文（Description）に含まれるHTMLタグは除去して表示します。

### X / Twitch
- **現状**: API制限および認証の複雑さを避けるため、`open` コマンドによるブラウザ遷移のみサポートしています。
- **将来展望**: 公式APIまたはスクレイピングによる情報取得の検討。

## 設定ファイル
- **場所**: `~/.config/valiv/config.json` (OSにより異なる場合があります)
- **形式**: JSON
- **内容**: 登録クリエイターのリスト
